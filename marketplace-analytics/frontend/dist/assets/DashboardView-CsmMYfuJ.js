import{d as G,a as m,c as M,x as H,b as d,o as n,F as O,e,f as o,i as y,w as k,y as J,k as V,p as j,z as le,t as f,h as A,n as I,A as W,B as re,C as oe,D as ne,q}from"./index-C06cxT_l.js";import{r as ie,_ as B,a as de,b as ce,c as ue,d as me,e as pe}from"./PieChart.vue_vue_type_script_setup_true_lang-Dt37QOlc.js";import{_ as b}from"./BaseButton.vue_vue_type_script_setup_true_lang-BdOSKptw.js";import{r as ve,u as N,_ as ye}from"./FileUpload.vue_vue_type_script_setup_true_lang-DpDWXOeL.js";import{r as K,a as Z,_ as fe,b as T,c as ge}from"./ConfirmationModal.vue_vue_type_script_setup_true_lang-CjKE-McZ.js";import{r as xe}from"./EyeIcon-DH4FWJBN.js";import"./ExclamationTriangleIcon-DG5ZDN47.js";const _e={class:"card"},be={class:"card-header"},he={class:"flex items-center justify-between"},ke={class:"flex items-center space-x-2"},we={class:"card-body"},$e={key:0,class:"flex justify-center py-8"},Re={key:1,class:"text-center py-8 text-gray-500"},Ce={key:2,class:"space-y-3"},De={class:"flex-1"},Ve={class:"flex items-center space-x-3"},Se={class:"flex-shrink-0"},Fe={class:"text-sm font-medium text-gray-900"},Ue={class:"flex items-center space-x-4 text-xs text-gray-500"},ze={key:0,class:"text-green-600"},Ee={key:1,class:"text-yellow-600"},Be={class:"flex items-center space-x-2"},Ne={class:"space-y-4"},Ae={class:"text-sm text-gray-600 mb-4"},Me={class:"mt-2 space-y-2"},Oe={class:"flex items-center"},je={class:"flex items-center"},Ie={class:"mt-4"},Le={key:0,class:"mt-2 text-sm text-red-600"},Pe={class:"flex justify-end space-x-3"},We=G({__name:"ReportsManager",emits:["reports-updated"],setup(Q,{emit:l}){const w=l,x=m([]),R=m(!1),p=m(null),C=m(!1),g=m(""),_=m([]),v=m(""),r=m(!1),t=m(),u=m(!1),$=m(!1),S=M(()=>g.value&&_.value.length>0&&!r.value),h=async()=>{try{R.value=!0,x.value=await N.getReports(),w("reports-updated")}catch(s){console.error("Error loading reports:",s)}finally{R.value=!1}},F=s=>s==="WILDBERRIES"?"Wildberries":"Ozon",U=s=>new Date(s).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),z=s=>{p.value=s,u.value=!0},c=()=>{$.value=!0},X=async()=>{if(p.value)try{await N.deleteReport(p.value.id),await h(),u.value=!1,p.value=null}catch(s){console.error("Error deleting report:",s)}},Y=async()=>{try{await N.deleteAllReports(),await h(),$.value=!1}catch(s){console.error("Error deleting all reports:",s)}},ee=s=>{p.value=s,g.value=s.marketplace,_.value=[],v.value="",C.value=!0},L=()=>{C.value=!1,p.value=null,g.value="",_.value=[],v.value="",t.value&&t.value.clearFiles()},te=s=>{_.value=s,v.value=""},ae=s=>{v.value=s},se=async()=>{var s,a;if(!(!S.value||!p.value))try{r.value=!0,v.value="",await N.replaceReport(p.value.id,_.value[0],g.value),await h(),L()}catch(E){v.value=((a=(s=E.response)==null?void 0:s.data)==null?void 0:a.message)||"Произошла ошибка при замене файла"}finally{r.value=!1}};return H(()=>{h()}),(s,a)=>{var E;return n(),d(O,null,[e("div",_e,[e("div",be,[e("div",he,[a[7]||(a[7]=e("h3",{class:"text-lg font-medium text-gray-900"},"Управление отчетами",-1)),e("div",ke,[o(b,{variant:"outline",size:"sm",icon:y(K),onClick:h,loading:R.value},{default:k(()=>[...a[5]||(a[5]=[V(" Обновить ",-1)])]),_:1},8,["icon","loading"]),o(b,{variant:"danger",size:"sm",icon:y(Z),onClick:c,disabled:x.value.length===0},{default:k(()=>[...a[6]||(a[6]=[V(" Очистить все ",-1)])]),_:1},8,["icon","disabled"])])])]),e("div",we,[R.value&&x.value.length===0?(n(),d("div",$e,[...a[8]||(a[8]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"},null,-1)])])):x.value.length===0?(n(),d("div",Re,[o(y(ve),{class:"mx-auto h-12 w-12 text-gray-400 mb-3"}),a[9]||(a[9]=e("p",null,"Нет загруженных отчетов",-1))])):(n(),d("div",Ce,[(n(!0),d(O,null,J(x.value,i=>{var D;return n(),d("div",{key:i.id,class:"flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors"},[e("div",De,[e("div",Ve,[e("div",Se,[o(y(le),{class:j(["h-8 w-8",i.processed?"text-green-500":"text-yellow-500"])},null,8,["class"])]),e("div",null,[e("h4",Fe,f(i.fileName),1),e("div",Ue,[e("span",null,f(F(i.marketplace)),1),e("span",null,f(U(i.uploadDate)),1),(D=i._count)!=null&&D.salesData?(n(),d("span",ze,f(i._count.salesData)+" записей ",1)):A("",!0),i.processed?A("",!0):(n(),d("span",Ee," Обрабатывается... "))])])])]),e("div",Be,[o(b,{variant:"outline",size:"sm",icon:y(xe),onClick:P=>s.$router.push(`/reports/${i.id}`),title:"Просмотреть отчет"},null,8,["icon","onClick"]),o(b,{variant:"outline",size:"sm",icon:y(ge),onClick:P=>ee(i),title:"Заменить файл"},null,8,["icon","onClick"]),o(b,{variant:"danger",size:"sm",icon:y(Z),onClick:P=>z(i),title:"Удалить отчет"},null,8,["icon","onClick"])])])}),128))]))])]),o(fe,{modelValue:C.value,"onUpdate:modelValue":a[2]||(a[2]=i=>C.value=i),title:"Заменить отчет",size:"md"},{footer:k(()=>[e("div",Pe,[o(b,{variant:"outline",onClick:L},{default:k(()=>[...a[14]||(a[14]=[V(" Отмена ",-1)])]),_:1}),o(b,{variant:"primary",onClick:se,loading:r.value,disabled:!S.value},{default:k(()=>[...a[15]||(a[15]=[V(" Заменить ",-1)])]),_:1},8,["loading","disabled"])])]),default:k(()=>{var i;return[e("div",Ne,[e("div",null,[e("p",Ae,' Заменить отчет "'+f((i=p.value)==null?void 0:i.fileName)+'" новым файлом? ',1),e("div",null,[a[12]||(a[12]=e("label",{class:"form-label"},"Маркетплейс",-1)),e("div",Me,[e("div",Oe,[I(e("input",{id:"replace-wildberries","onUpdate:modelValue":a[0]||(a[0]=D=>g.value=D),name:"marketplace",type:"radio",value:"WILDBERRIES",class:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"},null,512),[[W,g.value]]),a[10]||(a[10]=e("label",{for:"replace-wildberries",class:"ml-3 block text-sm font-medium text-gray-700"}," Wildberries ",-1))]),e("div",je,[I(e("input",{id:"replace-ozon","onUpdate:modelValue":a[1]||(a[1]=D=>g.value=D),name:"marketplace",type:"radio",value:"OZON",class:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"},null,512),[[W,g.value]]),a[11]||(a[11]=e("label",{for:"replace-ozon",class:"ml-3 block text-sm font-medium text-gray-700"}," Ozon ",-1))])])]),e("div",Ie,[a[13]||(a[13]=e("label",{class:"form-label"},"Новый файл",-1)),o(ye,{ref_key:"replaceFileUploadRef",ref:t,accept:".xlsx,.xls,.csv","max-size":52428800,onFilesSelected:te,onError:ae},null,512)]),v.value?(n(),d("div",Le,f(v.value),1)):A("",!0)])])]}),_:1},8,["modelValue"]),o(T,{modelValue:u.value,"onUpdate:modelValue":a[3]||(a[3]=i=>u.value=i),title:"Удалить отчет",message:`Вы уверены, что хотите удалить отчет '${(E=p.value)==null?void 0:E.fileName}'? Это действие нельзя отменить.`,"confirm-text":"Удалить","confirm-variant":"danger",onConfirm:X},null,8,["modelValue","message"]),o(T,{modelValue:$.value,"onUpdate:modelValue":a[4]||(a[4]=i=>$.value=i),title:"Удалить все отчеты",message:"Вы уверены, что хотите удалить ВСЕ отчеты? Это действие нельзя отменить и приведет к потере всех данных.","confirm-text":"Удалить все","confirm-variant":"danger",onConfirm:Y},null,8,["modelValue"])],64)}}}),qe={class:"space-y-6"},Ze={class:"border-b border-gray-200 pb-5"},Te={class:"flex items-center justify-between"},Ge={class:"flex items-center space-x-3"},He={key:0,class:"flex justify-center items-center h-64"},Je={key:1,class:"text-center py-12"},Ke={class:"mt-6"},Qe={key:2,class:"space-y-6"},Xe={class:"grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4"},Ye={class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},et={class:"card"},tt={class:"card-body"},at={key:1,class:"text-center py-8 text-gray-500"},st={class:"card"},lt={class:"card-body"},rt={key:1,class:"text-center py-8 text-gray-500"},ot={class:"card"},nt={class:"card-body"},it={key:0,class:"overflow-hidden"},dt={class:"min-w-full divide-y divide-gray-200"},ct={class:"bg-white divide-y divide-gray-200"},ut={class:"px-6 py-4 whitespace-nowrap"},mt={class:"text-sm font-medium text-gray-900"},pt={class:"text-sm text-gray-500"},vt={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},yt={class:"px-6 py-4 whitespace-nowrap text-sm"},ft={class:"px-6 py-4 whitespace-nowrap text-sm"},gt={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},xt={key:1,class:"text-center py-8 text-gray-500"},Ct=G({__name:"DashboardView",setup(Q){const l=m(null),w=m(!1),x=m("30d"),R=M(()=>{var t;return(t=l.value)!=null&&t.dailySales?{labels:l.value.dailySales.map(u=>new Date(u.date).toLocaleDateString("ru-RU",{month:"short",day:"numeric"})),datasets:[{label:"Выручка",data:l.value.dailySales.map(u=>u.revenue),borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.4},{label:"Прибыль",data:l.value.dailySales.map(u=>u.profit),borderColor:"rgb(34, 197, 94)",backgroundColor:"rgba(34, 197, 94, 0.1)",tension:.4}]}:{labels:[],datasets:[]}}),p=M(()=>{var t;if(!((t=l.value)!=null&&t.expenseBreakdown))return{labels:[],datasets:[]};const r=l.value.expenseBreakdown;return{labels:["Комиссии","Логистика","Хранение","Возвраты"],datasets:[{data:[r.commission,r.logistics,r.storage,r.returns],backgroundColor:["rgba(239, 68, 68, 0.8)","rgba(245, 158, 11, 0.8)","rgba(139, 92, 246, 0.8)","rgba(156, 163, 175, 0.8)"],borderColor:["rgba(239, 68, 68, 1)","rgba(245, 158, 11, 1)","rgba(139, 92, 246, 1)","rgba(156, 163, 175, 1)"],borderWidth:1}]}}),C={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0,ticks:{callback:function(r){return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:0,maximumFractionDigits:0}).format(r)}}}}},g={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(r){const t=r.label||"",u=_(r.parsed);return`${t}: ${u}`}}}}},_=r=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:0,maximumFractionDigits:0}).format(r),v=async()=>{try{w.value=!0,l.value=await pe.getDashboardAnalytics(x.value)}catch(r){console.error("Error loading analytics:",r),l.value=null}finally{w.value=!1}};return H(()=>{v()}),(r,t)=>{var u,$,S,h,F,U,z;return n(),d("div",qe,[e("div",Ze,[e("div",Te,[t[4]||(t[4]=e("div",null,[e("h1",{class:"text-2xl font-bold text-gray-900"},"Дашборд"),e("p",{class:"mt-1 text-sm text-gray-600"}," Обзор ваших продаж и аналитики ")],-1)),e("div",Ge,[I(e("select",{"onUpdate:modelValue":t[0]||(t[0]=c=>x.value=c),onChange:v,class:"form-input"},[...t[2]||(t[2]=[e("option",{value:"7d"},"Последние 7 дней",-1),e("option",{value:"30d"},"Последние 30 дней",-1),e("option",{value:"90d"},"Последние 90 дней",-1)])],544),[[re,x.value]]),o(b,{variant:"primary",icon:y(K),onClick:v,loading:w.value},{default:k(()=>[...t[3]||(t[3]=[V(" Обновить ",-1)])]),_:1},8,["icon","loading"])])])]),w.value&&!l.value?(n(),d("div",He,[...t[5]||(t[5]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"},null,-1)])])):!w.value&&!l.value?(n(),d("div",Je,[o(y(oe),{class:"mx-auto h-12 w-12 text-gray-400"}),t[7]||(t[7]=e("h3",{class:"mt-2 text-sm font-medium text-gray-900"},"Нет данных",-1)),t[8]||(t[8]=e("p",{class:"mt-1 text-sm text-gray-500"}," Загрузите первый отчет для начала работы с аналитикой ",-1)),e("div",Ke,[o(b,{variant:"primary",onClick:t[1]||(t[1]=c=>r.$router.push("/upload"))},{default:k(()=>[...t[6]||(t[6]=[V(" Загрузить файл ",-1)])]),_:1})])])):(n(),d("div",Qe,[o(We,{onReportsUpdated:v}),e("div",Xe,[o(B,{title:"Общая выручка",value:((u=l.value)==null?void 0:u.totalRevenue)||0,format:"currency",color:"blue",icon:y(ie),description:"За выбранный период"},null,8,["value","icon"]),o(B,{title:"Чистая прибыль",value:(($=l.value)==null?void 0:$.totalProfit)||0,format:"currency",color:"green",icon:y(de),description:"После всех комиссий"},null,8,["value","icon"]),o(B,{title:"Маржинальность",value:((S=l.value)==null?void 0:S.profitMargin)||0,format:"percentage",color:"purple",icon:y(ne),description:"Средняя по всем товарам"},null,8,["value","icon"]),o(B,{title:"Количество заказов",value:((h=l.value)==null?void 0:h.totalOrders)||0,format:"number",color:"yellow",icon:y(ce),description:"Общее количество продаж"},null,8,["value","icon"])]),e("div",Ye,[e("div",et,[t[9]||(t[9]=e("div",{class:"card-header"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Динамика продаж")],-1)),e("div",tt,[(F=l.value)!=null&&F.dailySales&&l.value.dailySales.length>0?(n(),q(ue,{key:0,data:R.value,options:C},null,8,["data"])):(n(),d("div",at," Недостаточно данных для отображения графика "))])]),e("div",st,[t[10]||(t[10]=e("div",{class:"card-header"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Структура расходов")],-1)),e("div",lt,[p.value.datasets[0].data.some(c=>c>0)?(n(),q(me,{key:0,data:p.value,options:g},null,8,["data"])):(n(),d("div",rt," Нет данных о расходах "))])])]),e("div",ot,[t[12]||(t[12]=e("div",{class:"card-header"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Топ товаров по прибыли")],-1)),e("div",nt,[(U=l.value)!=null&&U.topProducts&&l.value.topProducts.length>0?(n(),d("div",it,[e("table",dt,[t[11]||(t[11]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Товар "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Выручка "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Прибыль "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Маржа "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Количество ")])],-1)),e("tbody",ct,[(n(!0),d(O,null,J(((z=l.value)==null?void 0:z.topProducts)||[],c=>(n(),d("tr",{key:c.sku},[e("td",ut,[e("div",null,[e("div",mt,f(c.productName),1),e("div",pt,f(c.sku),1)])]),e("td",vt,f(_(c.revenue)),1),e("td",yt,[e("span",{class:j(c.profit>=0?"text-green-600":"text-red-600")},f(_(c.profit)),3)]),e("td",ft,[e("span",{class:j(c.profitMargin>=0?"text-green-600":"text-red-600")},f(c.profitMargin.toFixed(1))+"% ",3)]),e("td",gt,f(c.quantity),1)]))),128))])])])):(n(),d("div",xt," Нет данных о товарах "))])])]))])}}});export{Ct as default};
//# sourceMappingURL=DashboardView-CsmMYfuJ.js.map
