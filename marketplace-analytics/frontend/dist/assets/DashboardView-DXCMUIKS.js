import{d as G,a as m,c as P,x as H,b as n,o,F as O,e,f as r,i as p,w as k,y as J,k as D,p as A,z as ce,h as R,t as v,n as j,A as q,B as ue,C as me,D as ve,q as Z}from"./index-VpZQxTwI.js";import{a as K,r as pe,_ as B,b as fe,c as ye,d as ge,e as xe}from"./PieChart.vue_vue_type_script_setup_true_lang-CPymyYCI.js";import{_ as b}from"./BaseButton.vue_vue_type_script_setup_true_lang-RCuHMJ8G.js";import{r as be,u as N,_ as _e}from"./FileUpload.vue_vue_type_script_setup_true_lang-DWBaF2s6.js";import{r as Q,a as T,_ as he,b as I,c as ke}from"./ConfirmationModal.vue_vue_type_script_setup_true_lang-CK9t_sTQ.js";import{r as we}from"./ExclamationTriangleIcon-14f6j3RX.js";import{r as $e}from"./EyeIcon-CKpIxSL3.js";const Ce={class:"card"},Re={class:"card-header"},De={class:"flex items-center justify-between"},Se={class:"flex items-center space-x-2"},Ve={class:"card-body"},Fe={key:0,class:"flex justify-center py-8"},Ue={key:1,class:"text-center py-8 text-gray-500"},Ee={key:2,class:"space-y-3"},ze={class:"flex-1"},Me={class:"flex items-center space-x-3"},Be={class:"flex-shrink-0"},Ne={class:"flex-1"},Ae={class:"text-sm font-medium text-gray-900"},Ie={class:"flex items-center space-x-4 text-xs text-gray-500 mt-1"},Pe={key:0,class:"text-green-600 font-medium"},Oe={key:1,class:"text-yellow-600 font-medium"},je={key:0,class:"flex items-center space-x-4 text-xs text-gray-600 mt-1"},Le={key:0,class:"text-blue-600"},We={key:1,class:"text-green-600"},qe={key:2,class:"text-purple-600"},Ze={class:"flex items-center space-x-2"},Te={class:"space-y-4"},Ge={class:"text-sm text-gray-600 mb-4"},He={class:"mt-2 space-y-2"},Je={class:"flex items-center"},Ke={class:"flex items-center"},Qe={class:"mt-4"},Xe={key:0,class:"mt-2 text-sm text-red-600"},Ye={class:"flex justify-end space-x-3"},et=G({__name:"ReportsManager",emits:["reports-updated"],setup(X,{emit:i}){const w=i,g=m([]),S=m(!1),f=m(null),V=m(!1),x=m(""),_=m([]),y=m(""),d=m(!1),a=m(),u=m(!1),$=m(!1),C=m(!1),U=P(()=>x.value&&_.value.length>0&&!d.value),h=async()=>{try{S.value=!0,g.value=await N.getReports(),w("reports-updated")}catch(s){console.error("Error loading reports:",s)}finally{S.value=!1}},E=s=>s==="WILDBERRIES"?"Wildberries":"Ozon",z=s=>new Date(s).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),c=s=>new Intl.NumberFormat("ru-RU").format(Math.round(s)),Y=s=>s==="WILDBERRIES"?"bg-purple-100 text-purple-800":"bg-blue-100 text-blue-800",ee=s=>{f.value=s,u.value=!0},te=()=>{$.value=!0},ae=()=>{C.value=!0},se=async()=>{if(f.value)try{await N.deleteReport(f.value.id),await h(),u.value=!1,f.value=null}catch(s){console.error("Error deleting report:",s)}},le=async()=>{try{await N.deleteAllReports(),await h(),$.value=!1}catch(s){console.error("Error deleting all reports:",s)}},oe=async()=>{try{const s=await K.clearStatistics();console.log("Statistics cleared:",s),await h(),C.value=!1}catch(s){console.error("Error clearing statistics:",s)}},re=s=>{f.value=s,x.value=s.marketplace,_.value=[],y.value="",V.value=!0},L=()=>{V.value=!1,f.value=null,x.value="",_.value=[],y.value="",a.value&&a.value.clearFiles()},ne=s=>{_.value=s,y.value=""},ie=s=>{y.value=s},de=async()=>{var s,t;if(!(!U.value||!f.value))try{d.value=!0,y.value="",await N.replaceReport(f.value.id,_.value[0],x.value),await h(),L()}catch(M){y.value=((t=(s=M.response)==null?void 0:s.data)==null?void 0:t.message)||"Произошла ошибка при замене файла"}finally{d.value=!1}};return H(()=>{h()}),(s,t)=>{var M;return o(),n(O,null,[e("div",Ce,[e("div",Re,[e("div",De,[t[9]||(t[9]=e("h3",{class:"text-lg font-medium text-gray-900"},"Управление отчетами",-1)),e("div",Se,[r(b,{variant:"outline",size:"sm",icon:p(Q),onClick:h,loading:S.value},{default:k(()=>[...t[6]||(t[6]=[D(" Обновить ",-1)])]),_:1},8,["icon","loading"]),r(b,{variant:"danger",size:"sm",icon:p(T),onClick:te,disabled:g.value.length===0},{default:k(()=>[...t[7]||(t[7]=[D(" Удалить все отчеты ",-1)])]),_:1},8,["icon","disabled"]),r(b,{variant:"danger",size:"sm",icon:p(we),onClick:ae,disabled:g.value.length===0},{default:k(()=>[...t[8]||(t[8]=[D(" Сбросить статистику ",-1)])]),_:1},8,["icon","disabled"])])])]),e("div",Ve,[S.value&&g.value.length===0?(o(),n("div",Fe,[...t[10]||(t[10]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"},null,-1)])])):g.value.length===0?(o(),n("div",Ue,[r(p(be),{class:"mx-auto h-12 w-12 text-gray-400 mb-3"}),t[11]||(t[11]=e("p",null,"Нет загруженных отчетов",-1))])):(o(),n("div",Ee,[(o(!0),n(O,null,J(g.value,l=>{var F;return o(),n("div",{key:l.id,class:"flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors"},[e("div",ze,[e("div",Me,[e("div",Be,[r(p(ce),{class:A(["h-8 w-8",l.processed?"text-green-500":"text-yellow-500"])},null,8,["class"])]),e("div",Ne,[e("h4",Ae,v(l.fileName),1),e("div",Ie,[e("span",{class:A(["inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",Y(l.marketplace)])},v(E(l.marketplace)),3),e("span",null,v(z(l.uploadDate)),1),(F=l._count)!=null&&F.salesData?(o(),n("span",Pe,v(l._count.salesData)+" записей ",1)):R("",!0),l.processed?R("",!0):(o(),n("span",Oe," Обрабатывается... "))]),l.totalRevenue||l.totalProfit?(o(),n("div",je,[l.totalRevenue?(o(),n("span",Le," Выручка: ₽"+v(c(l.totalRevenue)),1)):R("",!0),l.totalProfit?(o(),n("span",We," Прибыль: ₽"+v(c(l.totalProfit)),1)):R("",!0),l.profitMargin?(o(),n("span",qe," Маржа: "+v(l.profitMargin.toFixed(1))+"% ",1)):R("",!0)])):R("",!0)])])]),e("div",Ze,[r(b,{variant:"outline",size:"sm",icon:p($e),onClick:W=>s.$router.push(`/reports/${l.id}`),title:"Просмотреть отчет"},null,8,["icon","onClick"]),r(b,{variant:"outline",size:"sm",icon:p(ke),onClick:W=>re(l),title:"Заменить файл"},null,8,["icon","onClick"]),r(b,{variant:"danger",size:"sm",icon:p(T),onClick:W=>ee(l),title:"Удалить отчет"},null,8,["icon","onClick"])])])}),128))]))])]),r(he,{modelValue:V.value,"onUpdate:modelValue":t[2]||(t[2]=l=>V.value=l),title:"Заменить отчет",size:"md"},{footer:k(()=>[e("div",Ye,[r(b,{variant:"outline",onClick:L},{default:k(()=>[...t[16]||(t[16]=[D(" Отмена ",-1)])]),_:1}),r(b,{variant:"primary",onClick:de,loading:d.value,disabled:!U.value},{default:k(()=>[...t[17]||(t[17]=[D(" Заменить ",-1)])]),_:1},8,["loading","disabled"])])]),default:k(()=>{var l;return[e("div",Te,[e("div",null,[e("p",Ge,' Заменить отчет "'+v((l=f.value)==null?void 0:l.fileName)+'" новым файлом? ',1),e("div",null,[t[14]||(t[14]=e("label",{class:"form-label"},"Маркетплейс",-1)),e("div",He,[e("div",Je,[j(e("input",{id:"replace-wildberries","onUpdate:modelValue":t[0]||(t[0]=F=>x.value=F),name:"marketplace",type:"radio",value:"WILDBERRIES",class:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"},null,512),[[q,x.value]]),t[12]||(t[12]=e("label",{for:"replace-wildberries",class:"ml-3 block text-sm font-medium text-gray-700"}," Wildberries ",-1))]),e("div",Ke,[j(e("input",{id:"replace-ozon","onUpdate:modelValue":t[1]||(t[1]=F=>x.value=F),name:"marketplace",type:"radio",value:"OZON",class:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"},null,512),[[q,x.value]]),t[13]||(t[13]=e("label",{for:"replace-ozon",class:"ml-3 block text-sm font-medium text-gray-700"}," Ozon ",-1))])])]),e("div",Qe,[t[15]||(t[15]=e("label",{class:"form-label"},"Новый файл",-1)),r(_e,{ref_key:"replaceFileUploadRef",ref:a,accept:".xlsx,.xls,.csv","max-size":52428800,onFilesSelected:ne,onError:ie},null,512)]),y.value?(o(),n("div",Xe,v(y.value),1)):R("",!0)])])]}),_:1},8,["modelValue"]),r(I,{modelValue:u.value,"onUpdate:modelValue":t[3]||(t[3]=l=>u.value=l),title:"Удалить отчет",message:`Вы уверены, что хотите удалить отчет '${(M=f.value)==null?void 0:M.fileName}'? Это действие нельзя отменить.`,"confirm-text":"Удалить","confirm-variant":"danger",onConfirm:se},null,8,["modelValue","message"]),r(I,{modelValue:$.value,"onUpdate:modelValue":t[4]||(t[4]=l=>$.value=l),title:"Удалить все отчеты",message:"Вы уверены, что хотите удалить ВСЕ отчеты? Это действие нельзя отменить и приведет к потере всех данных.","confirm-text":"Удалить все","confirm-variant":"danger",onConfirm:le},null,8,["modelValue"]),r(I,{modelValue:C.value,"onUpdate:modelValue":t[5]||(t[5]=l=>C.value=l),title:"Сбросить всю статистику",message:"Вы уверены, что хотите сбросить ВСЮ статистику? Это действие удалит все отчеты, данные продаж и файлы. Восстановить данные будет невозможно.","confirm-text":"Сбросить статистику","confirm-variant":"danger",onConfirm:oe},null,8,["modelValue"])],64)}}}),tt={class:"space-y-6"},at={class:"border-b border-gray-200 pb-5"},st={class:"flex items-center justify-between"},lt={class:"flex items-center space-x-3"},ot={key:0,class:"flex justify-center items-center h-64"},rt={key:1,class:"text-center py-12"},nt={class:"mt-6"},it={key:2,class:"space-y-6"},dt={class:"grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4"},ct={class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},ut={class:"card"},mt={class:"card-body"},vt={key:1,class:"text-center py-8 text-gray-500"},pt={class:"card"},ft={class:"card-body"},yt={key:1,class:"text-center py-8 text-gray-500"},gt={class:"card"},xt={class:"card-body"},bt={key:0,class:"overflow-hidden"},_t={class:"min-w-full divide-y divide-gray-200"},ht={class:"bg-white divide-y divide-gray-200"},kt={class:"px-6 py-4 whitespace-nowrap"},wt={class:"text-sm font-medium text-gray-900"},$t={class:"text-sm text-gray-500"},Ct={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},Rt={class:"px-6 py-4 whitespace-nowrap text-sm"},Dt={class:"px-6 py-4 whitespace-nowrap text-sm"},St={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-900"},Vt={key:1,class:"text-center py-8 text-gray-500"},At=G({__name:"DashboardView",setup(X){const i=m(null),w=m(!1),g=m("30d"),S=P(()=>{var a;return(a=i.value)!=null&&a.dailySales?{labels:i.value.dailySales.map(u=>new Date(u.date).toLocaleDateString("ru-RU",{month:"short",day:"numeric"})),datasets:[{label:"Выручка",data:i.value.dailySales.map(u=>u.revenue),borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.4},{label:"Прибыль",data:i.value.dailySales.map(u=>u.profit),borderColor:"rgb(34, 197, 94)",backgroundColor:"rgba(34, 197, 94, 0.1)",tension:.4}]}:{labels:[],datasets:[]}}),f=P(()=>{var a;if(!((a=i.value)!=null&&a.expenseBreakdown))return{labels:[],datasets:[]};const d=i.value.expenseBreakdown;return{labels:["Комиссии","Логистика","Хранение","Возвраты"],datasets:[{data:[d.commission,d.logistics,d.storage,d.returns],backgroundColor:["rgba(239, 68, 68, 0.8)","rgba(245, 158, 11, 0.8)","rgba(139, 92, 246, 0.8)","rgba(156, 163, 175, 0.8)"],borderColor:["rgba(239, 68, 68, 1)","rgba(245, 158, 11, 1)","rgba(139, 92, 246, 1)","rgba(156, 163, 175, 1)"],borderWidth:1}]}}),V={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0,ticks:{callback:function(d){return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:0,maximumFractionDigits:0}).format(d)}}}}},x={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(d){const a=d.label||"",u=_(d.parsed);return`${a}: ${u}`}}}}},_=d=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:0,maximumFractionDigits:0}).format(d),y=async()=>{try{w.value=!0,i.value=await K.getDashboardAnalytics(g.value)}catch(d){console.error("Error loading analytics:",d),i.value=null}finally{w.value=!1}};return H(()=>{y()}),(d,a)=>{var u,$,C,U,h,E,z;return o(),n("div",tt,[e("div",at,[e("div",st,[a[4]||(a[4]=e("div",null,[e("h1",{class:"text-2xl font-bold text-gray-900"},"Дашборд"),e("p",{class:"mt-1 text-sm text-gray-600"}," Обзор ваших продаж и аналитики ")],-1)),e("div",lt,[j(e("select",{"onUpdate:modelValue":a[0]||(a[0]=c=>g.value=c),onChange:y,class:"form-input"},[...a[2]||(a[2]=[e("option",{value:"7d"},"Последние 7 дней",-1),e("option",{value:"30d"},"Последние 30 дней",-1),e("option",{value:"90d"},"Последние 90 дней",-1)])],544),[[ue,g.value]]),r(b,{variant:"primary",icon:p(Q),onClick:y,loading:w.value},{default:k(()=>[...a[3]||(a[3]=[D(" Обновить ",-1)])]),_:1},8,["icon","loading"])])])]),w.value&&!i.value?(o(),n("div",ot,[...a[5]||(a[5]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"},null,-1)])])):!w.value&&!i.value?(o(),n("div",rt,[r(p(me),{class:"mx-auto h-12 w-12 text-gray-400"}),a[7]||(a[7]=e("h3",{class:"mt-2 text-sm font-medium text-gray-900"},"Нет данных",-1)),a[8]||(a[8]=e("p",{class:"mt-1 text-sm text-gray-500"}," Загрузите первый отчет для начала работы с аналитикой ",-1)),e("div",nt,[r(b,{variant:"primary",onClick:a[1]||(a[1]=c=>d.$router.push("/upload"))},{default:k(()=>[...a[6]||(a[6]=[D(" Загрузить файл ",-1)])]),_:1})])])):(o(),n("div",it,[r(et,{onReportsUpdated:y}),e("div",dt,[r(B,{title:"Общая выручка",value:((u=i.value)==null?void 0:u.totalRevenue)||0,format:"currency",color:"blue",icon:p(pe),description:"За выбранный период"},null,8,["value","icon"]),r(B,{title:"Чистая прибыль",value:(($=i.value)==null?void 0:$.totalProfit)||0,format:"currency",color:"green",icon:p(fe),description:"После всех комиссий"},null,8,["value","icon"]),r(B,{title:"Маржинальность",value:((C=i.value)==null?void 0:C.profitMargin)||0,format:"percentage",color:"purple",icon:p(ve),description:"Средняя по всем товарам"},null,8,["value","icon"]),r(B,{title:"Количество заказов",value:((U=i.value)==null?void 0:U.totalOrders)||0,format:"number",color:"yellow",icon:p(ye),description:"Общее количество продаж"},null,8,["value","icon"])]),e("div",ct,[e("div",ut,[a[9]||(a[9]=e("div",{class:"card-header"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Динамика продаж")],-1)),e("div",mt,[(h=i.value)!=null&&h.dailySales&&i.value.dailySales.length>0?(o(),Z(ge,{key:0,data:S.value,options:V},null,8,["data"])):(o(),n("div",vt," Недостаточно данных для отображения графика "))])]),e("div",pt,[a[10]||(a[10]=e("div",{class:"card-header"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Структура расходов")],-1)),e("div",ft,[f.value.datasets[0].data.some(c=>c>0)?(o(),Z(xe,{key:0,data:f.value,options:x},null,8,["data"])):(o(),n("div",yt," Нет данных о расходах "))])])]),e("div",gt,[a[12]||(a[12]=e("div",{class:"card-header"},[e("h3",{class:"text-lg font-medium text-gray-900"},"Топ товаров по прибыли")],-1)),e("div",xt,[(E=i.value)!=null&&E.topProducts&&i.value.topProducts.length>0?(o(),n("div",bt,[e("table",_t,[a[11]||(a[11]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Товар "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Выручка "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Прибыль "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Маржа "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Количество ")])],-1)),e("tbody",ht,[(o(!0),n(O,null,J(((z=i.value)==null?void 0:z.topProducts)||[],c=>(o(),n("tr",{key:c.sku},[e("td",kt,[e("div",null,[e("div",wt,v(c.productName),1),e("div",$t,v(c.sku),1)])]),e("td",Ct,v(_(c.revenue)),1),e("td",Rt,[e("span",{class:A(c.profit>=0?"text-green-600":"text-red-600")},v(_(c.profit)),3)]),e("td",Dt,[e("span",{class:A(c.profitMargin>=0?"text-green-600":"text-red-600")},v(c.profitMargin.toFixed(1))+"% ",3)]),e("td",St,v(c.quantity),1)]))),128))])])])):(o(),n("div",Vt," Нет данных о товарах "))])])]))])}}});export{At as default};
//# sourceMappingURL=DashboardView-DXCMUIKS.js.map
